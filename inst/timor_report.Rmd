---
title: "The fisheries of Timor-Leste"
subtitle: "A detailed analysis of three years of small-scale fisheries catch and effort data in Timor-Leste"
date: "Last compiled on `r Sys.time()`"
mainfont: Montserrat
geometry: "left=3cm,right=3cm,top=2cm,bottom=2cm"
output:
  bookdown::pdf_book:
    latex_engine: lualatex
    toc: yes
    toc_depth: 2
    number_sections: true
  bookdown::word_document2:
    number_sections: true
    toc: true
  bookdown::html_document2:
    number_sections: true
    toc: true
header-includes: 
  - \usepackage{float} 
  - \floatplacement{figure}{H}
  - \usepackage{leading}
  - \leading{16pt}
  - \definecolor{myblue}{RGB}{68,117,151}
  - \let\counterwithout\relax
  - \let\counterwithin\relax
  - \usepackage{chngcntr}
  - \usepackage{caption}
  - \captionsetup[figure]{font=footnotesize}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = FALSE)
```

```{r, include=FALSE}
# libraries
library(magrittr)
library(ggplot2)
library(tidytext)
library(timetk)
library(ggchicklet)
library(cowplot)
library(ggpubr)

setwd("../..")
pars <- timor.report::read_config()

# load data
report_data <- timor.report::report_data

# Store useful plotting functions:
label_date <- function(x) {
  format(x, "%b") %>%
    stringr::str_replace("Jan", paste0("Jan\n", format(x, "%Y")))
}

absolute_percent <- function(x) {
  scales::percent(abs(x), scale = 1)
}

paste_percent <- function(x) {
  paste0(x, "%")
}
```

# Effort and landings

(ref:IRIFishGroups) **Catch composition on the three strata using the Index of Relative Importance (IRI).** Catch composition using the Index of Relative Importance (IRI) of the landings of Atauro island, north coast, and south coast for the period of September 2016 to April 2021. The IRI considers the weight, the number, and the frequency of occurrence (FRQ) of a functional group.

```{r IRIFishGroups, echo=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=9, fig.cap='(ref:IRIFishGroups)'}
# create base dataset for plotting
plot_dat <- 
report_data %>%
  dplyr::group_by(area, fish_group) %>%
  dplyr::summarise(
    weight = sum(weight),
    individuals = sum(individuals),
    obs = dplyr::n()
  ) %>%
  dplyr::group_by(area) %>%
  dplyr::mutate(
    weight_tot = sum(weight),
    individuals_tot = sum(individuals),
    obs_tot = sum(obs)
  ) %>%
  dplyr::ungroup() %>%
  dplyr::transmute(
    area = area,
    fish_group,
    weight_perc = weight / weight_tot * 100,
    individuals_perc = (individuals / individuals_tot * 100)*-1,
    obs_perc = as.factor(round(obs / obs_tot * 100, 0))
  ) %>%
  tidyr::pivot_longer(-c(area, fish_group, obs_perc)) %>%
  dplyr::ungroup() 

# create function to iterate on arguments
plot_fish_groups <- function(data, coast){
  dat <- 
    data %>% 
    dplyr::filter(area == coast)
  
  y_label <- ifelse(unique(dat$area %in% "Atauro island"), "FRQ of occurrence", "")
  
  main_plot <- 
    ggplot(dat, aes(obs_perc,value, fill = fish_group)) +
    geom_chicklet(alpha = 0.75, radius = grid::unit(4, "pt"))+
    geom_hline(yintercept = 0, size = 0.2, color = "grey30")+
    coord_flip()+
    theme_minimal()+
    scale_fill_viridis_d(begin = 0, end = 1)+
    scale_y_continuous(labels = absolute_percent, n.breaks = 7)+
    scale_x_discrete(labels = paste_percent)+
    labs(fill = "Functional group")+
    theme(legend.position = "bottom",
          legend.key.size = unit(0.7, 'cm'))+
    guides(fill = guide_legend(nrow = 3,
                               label.theme = element_text(size = 11)))
  
  leg <<-   
    ggpubr::get_legend(main_plot) %>% 
    ggpubr::as_ggplot()
  
  main_plot +
    labs(x = y_label,
         y = "N. individuals                      Weight",
         title = coast)+
    theme(legend.position = "none",
          plot.title = element_text(hjust = 0.5))
}

all_plots <- purrr::map(unique(plot_dat$area), ~ plot_fish_groups(data = plot_dat, coast = .x))
main_plot <- cowplot::plot_grid(plotlist = all_plots, ncol = 3, align = "hv")

cowplot::plot_grid(main_plot,
                   leg,
                   ncol = 1, nrow=2,
                   rel_heights = c(3, 0.75))

```
